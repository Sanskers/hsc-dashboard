<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hardcore Survivor Challenge Progress</title>
  <style>
    /* ───────────────────────────────────────────────────────── */
    /* 1) Reset & Background */
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-image: url("https://deadbydaylight.com/static/a5cdc5db3804f817df112184c81f5ead/93f85/dbd-gallery-background.jpg");
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      background-attachment: fixed;
      background-color: #f5f5f5;
      color: #333;
    }

    /* ───────────────────────────────────────────────────────── */
    /* 2) Container & Buttons */
    .container {
      max-width: 960px;
      margin: 40px auto;
      padding: 20px;
      background-color: rgba(255,255,255,0.9);
      border-radius: 8px;
    }
    .btn, #controls button {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #3498db;
      color: #fff;
      text-decoration: none;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px 15px;
    }
    .btn:hover, #controls button:hover {
      background-color: #2980b9;
    }
    #controls button.active {
      background-color: #2980b9;
    }

    /* ───────────────────────────────────────────────────────── */
    /* 3) Stats & Filters */
    #stats {
      text-align: center;
      margin-bottom: 15px;
      font-weight: bold;
    }
    #stats span { margin: 0 10px; }

    #controls {
      text-align: center;
      margin-bottom: 20px;
    }

    /* ───────────────────────────────────────────────────────── */
    /* 4) Loading Spinner & Error */
    #loading {
      text-align: center;
      margin-top: 60px;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #error {
      display: none;
      text-align: center;
      color: #e74c3c;
      margin-top: 40px;
      font-size: 1.1rem;
    }

    /* ───────────────────────────────────────────────────────── */
    /* 5) Players Grid & Cards */
    .players-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .player-card {
      width: 220px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: visible;
      transition: transform .15s ease-in-out;
    }
    .player-card:hover { transform: translateY(-4px); }

    .img-container {
      position: relative;
      width: 100%;
      height: 200px;
      background-color: #ddd;
      overflow: visible;
    }
    .img-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .pip-overlay {
      position: absolute;
      top: 90%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      pointer-events: none;
    }
    .pip-overlay img {
      width: 60px;
      height: 60px;
      margin-left: -20px;
    }
    .pip-overlay img:first-child { margin-left: 0; }

    .player-card-content {
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .player-name {
      font-size: 1.2rem;
      font-weight: bold;
      text-align: center;
      color: #2c3e50;
    }
    .field span {
      font-weight: 600;
    }

    /* ───────────────────────────────────────────────────────── */
    /* 6) Survivors Grid & Modal */
    .survivors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-top: 30px;
      justify-items: center;
      justify-content: center;
    }
    .survivor-card {
      width: 100px;
      background-color: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      text-align: center;
      cursor: pointer;
    }
    .survivor-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      background-color: #ddd;
    }
    .survivor-name {
      font-size: 0.75rem;
      padding: 4px 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Modal */
    .modal {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }
    .modal-close {
      position: absolute;
      top: 8px; right: 12px;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-content img {
      width: 120px; height: 120px;
      object-fit: cover; border-radius: 6px;
      margin-bottom: 12px;
    }
    .modal-content ul {
      list-style: none; padding: 0; margin: 0;
      text-align: left;
    }
    .modal-content li {
      margin: 6px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Hardcore Survivor Challenge Progress</h1>
    <a href="rules.html" class="btn">Rules</a>

    <div id="stats">
      <span>Total Pips: <span id="totalPips">0</span></span> |
      <span>Alive: <span id="aliveCount">0</span></span> |
      <span>Killed: <span id="deadCount">0</span></span>
    </div>

    <div id="controls">
      <button data-filter="all" class="active">All</button>
      <button data-filter="alive">Alive</button>
      <button data-filter="dead">Dead</button>
    </div>

    <div id="loading">
      <div class="spinner"></div>
      <div>Loading data…</div>
    </div>
    <div id="error"></div>

    <div id="playersGrid" class="players-grid" style="display:none;"></div>
    <div id="survivorsGrid" class="survivors-grid" style="display:none;"></div>
  </div>

  <!-- Survivor Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2 id="modalTitle"></h2>
      <img id="modalImg" src="" alt="" />
      <h3>Base Perks</h3>
      <ul id="modalPerks"></ul>
    </div>
  </div>

  <script>
    const CSV_PLAYERS   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSuKBNjFUHOp6l8oLtOFIxIUkZUmXk0fyKkYtSrREuIlrOn8iJsZOEsvU0W0M3BUdiWdZ3kSHo66-iJ/pub?gid=0&single=true&output=csv';
    const CSV_SURVIVORS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSuKBNjFUHOp6l8oLtOFIxIUkZUmXk0fyKkYtSrREuIlrOn8iJsZOEsvU0W0M3BUdiWdZ3kSHo66-iJ/pub?gid=88342992&single=true&output=csv';

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).filter(l=>l).map(line => {
        const cols = line.split(',');
        const obj = {};
        headers.forEach((h,i)=> obj[h.trim()] = (cols[i]||'').trim());
        return obj;
      });
    }

    async function loadAndRender() {
      try {
        const [r1,r2] = await Promise.all([fetch(CSV_PLAYERS), fetch(CSV_SURVIVORS)]);
        if (!r1.ok) throw new Error(`Players fetch ${r1.status}`);
        if (!r2.ok) throw new Error(`Survivors fetch ${r2.status}`);
        const playersData   = parseCSV(await r1.text());
        const survivorsData = parseCSV(await r2.text());

        // Hide spinner
        document.getElementById('loading').style.display = 'none';

        // Stats
        const totalPips  = playersData.reduce((sum,r)=> sum + (parseInt(r.Pips)||0), 0);
        const aliveCount = survivorsData.filter(r=>r.Status.toLowerCase()==='alive').length;
        const deadCount  = survivorsData.length - aliveCount;
        document.getElementById('totalPips').textContent = totalPips;
        document.getElementById('aliveCount').textContent = aliveCount;
        document.getElementById('deadCount').textContent  = deadCount;

        // Render Players
        const pGrid = document.getElementById('playersGrid');
        pGrid.style.display = 'flex';
        playersData.forEach(row => {
          const { Player, Survivor, ImageURL, Rank, Pips, PerksAllowed, Twitch, Status } = row;
          const pipCount = parseInt(Pips)||0;

          const card = document.createElement('div');
          card.className = 'player-card';
          card.dataset.status = (Status||'').toLowerCase();

          // Portrait + pips
          const imgContainer = document.createElement('div');
          imgContainer.className = 'img-container';
          const img = document.createElement('img');
          img.src = ImageURL; img.alt = Survivor;
          imgContainer.appendChild(img);

          const pipOverlay = document.createElement('div');
          pipOverlay.className = 'pip-overlay';
          const PIP_URL = 'https://i.imgur.com/KgiVO6X.png';
          for(let i=0;i<pipCount;i++){
            const pi = document.createElement('img');
            pi.src = PIP_URL; pi.alt='pip';
            pipOverlay.appendChild(pi);
          }
          imgContainer.appendChild(pipOverlay);

          // Twitch embed
          if (Twitch) {
            const channel = Twitch.split('/').pop();
            const ifr = document.createElement('iframe');
            ifr.src = `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}`;
            ifr.width = '220'; ifr.height='120';
            ifr.setAttribute('allowfullscreen','');
            card.appendChild(ifr);
          }

          card.appendChild(imgContainer);

          // Info
          const content = document.createElement('div');
          content.className = 'player-card-content';

          const nameEl = document.createElement('div');
          nameEl.className='player-name'; nameEl.textContent=Player;
          content.appendChild(nameEl);

          const survEl = document.createElement('div');
          survEl.className='field';
          survEl.innerHTML=`<span>Survivor:</span> ${Survivor}`;
          content.appendChild(survEl);

          const perksEl = document.createElement('div');
          perksEl.className='field';
          perksEl.innerHTML=`<span>Perks:</span> ${PerksAllowed}`;
          content.appendChild(perksEl);

          const rankEl = document.createElement('div');
          rankEl.className='field';
          rankEl.innerHTML=`<span>Rank:</span> ${Rank}`;
          content.appendChild(rankEl);

          const pipsText = document.createElement('div');
          pipsText.className='field';
          pipsText.innerHTML=`<span>Pips:</span> ${pipCount}`;
          content.appendChild(pipsText);

          card.appendChild(content);
          pGrid.appendChild(card);
        });

        // Render Survivors
        const sGrid = document.getElementById('survivorsGrid');
        sGrid.style.display = 'grid';
        survivorsData.forEach(row => {
          const { Survivor, Status, ImageURL, BasePerks } = row;
          const card = document.createElement('div');
          card.className='survivor-card';
          card.dataset.status = (Status||'').toLowerCase();
          card.dataset.name = Survivor;
          card.dataset.image = ImageURL;
          card.dataset.perks = BasePerks;

          const img = document.createElement('img');
          img.src = ImageURL; img.alt = Survivor;
          card.appendChild(img);

          const nameEl = document.createElement('div');
          nameEl.className='survivor-name'; nameEl.textContent=Survivor;
          nameEl.style.color = (Status.toLowerCase()==='dead') ? '#c0392b':'#27ae60';
          card.appendChild(nameEl);

          card.addEventListener('click', () => {
  // 1) Grab the raw perks string
  const perksRaw = row.BasePerks || '';

  // 2) Split on commas (trimming whitespace) and drop any empties
  const perksList = perksRaw
    .split(/\s*,\s*/)
    .filter(p => p);

  // 3) Clear out any previous list items
  const ul = document.getElementById('modalPerks');
  ul.innerHTML = '';

  // 4) For each perk, create an <li> then fetch its description
  perksList.forEach(perkName => {
    const li = document.createElement('li');
    const title = document.createElement('strong');
    title.textContent = perkName;
    li.appendChild(title);
    ul.appendChild(li);

    // Fetch first-paragraph from Wiki
    fetch(
      'https://deadbydaylight.fandom.com/api.php' +
      '?action=query&format=json&prop=extracts' +
      '&exintro=1&explaintext=1' +
      '&titles=' + encodeURIComponent(perkName) +
      '&origin=*'
    )
    .then(r => r.json())
    .then(data => {
      const pages = data.query.pages;
      const page  = pages[Object.keys(pages)[0]];
      const desc  = page.extract || 'No description available.';
      const p     = document.createElement('p');
      p.textContent = desc;
      p.style.margin = '4px 0 12px';
      p.style.fontSize = '0.9rem';
      li.appendChild(p);
    })
    .catch(() => {
      const p = document.createElement('p');
      p.textContent = 'Description unavailable.';
      p.style.margin = '4px 0 12px';
      p.style.fontSize = '0.9rem';
      li.appendChild(p);
    });
  });

  // 5) Finally show the modal
  document.getElementById('modalTitle').textContent = row.Survivor;
  document.getElementById('modalImg').src = row.ImageURL;
  document.getElementById('modal').style.display = 'flex';
});



          sGrid.appendChild(card);
        });

        // Filters
        document.getElementById('controls').addEventListener('click', e=> {
          if (!e.target.dataset.filter) return;
          const f = e.target.dataset.filter;
          document.querySelectorAll('#controls button')
            .forEach(b=>b.classList.toggle('active', b.dataset.filter===f));
          document.querySelectorAll('.player-card, .survivor-card')
            .forEach(c=> c.style.display = (f==='all'||c.dataset.status===f)?'':'none');
        });

        // Modal close
        document.querySelector('.modal-close').onclick = ()=> {
          document.getElementById('modal').style.display='none';
        };
        document.getElementById('modal').addEventListener('click', e=> {
          if (e.target.id==='modal') e.target.style.display='none';
        });

      } catch (err) {
        document.getElementById('loading').style.display='none';
        const eEl = document.getElementById('error');
        eEl.style.display='block';
        eEl.textContent = 'Error loading data: ' + err.message;
      }
    }

    document.addEventListener('DOMContentLoaded', loadAndRender);
  </script>
</body>
</html>
